<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOS Scalping Dashboard</title>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #30363d;
        }
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        select, input, button {
            background-color: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 8px 12px;
            border-radius: 6px;
        }
        button {
            cursor: pointer;
            font-weight: bold;
            background-color: #238636;
            border-color: rgba(240, 246, 252, 0.1);
        }
        button:hover {
            background-color: #2ea043;
        }
        .chart-container {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .chart-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #58a6ff;
        }
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .chart-wrapper {
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸš€ SOS Scalping Dashboard</h1>
        <div class="controls">
            <select id="symbol-select">
                <option value="NIFTY">NIFTY</option>
                <option value="BANKNIFTY">BANKNIFTY</option>
            </select>
            <input type="date" id="date-select" value="2026-01-16">
            <button id="load-btn">Load Dashboard</button>
            <label>
                <input type="checkbox" id="live-mode"> Live Mode
            </label>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title" id="index-title">Index Chart</div>
        <div id="main-chart" class="chart-wrapper"></div>
    </div>

    <div class="options-grid">
        <div class="chart-container">
            <div class="chart-title" id="ce-title">ATM CE Chart</div>
            <div id="ce-chart" class="chart-wrapper" style="height: 300px;"></div>
        </div>
        <div class="chart-container">
            <div class="chart-title" id="pe-title">ATM PE Chart</div>
            <div id="pe-chart" class="chart-wrapper" style="height: 300px;"></div>
        </div>
    </div>

    <script>
        let series = {};
        let charts = {};
        let isFirstLoad = true;
        let markers = { main: [], ce: [], pe: [] };

        function createChart(containerId, height) {
            const container = document.getElementById(containerId);
            const chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: height,
                layout: {
                    backgroundColor: '#161b22',
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: { color: '#30363d' },
                    horzLines: { color: '#30363d' },
                },
                timeScale: {
                    timeVisible: true,
                    secondsVisible: false,
                },
                localization: {
                    locale: 'en-US',
                }
            });

            const candlestickSeries = chart.addCandlestickSeries({
                upColor: '#26a69a', downColor: '#ef5350', borderVisible: false,
                wickUpColor: '#26a69a', wickDownColor: '#ef5350',
            });

            window.addEventListener('resize', () => {
                chart.applyOptions({ width: container.clientWidth });
            });

            charts[containerId] = chart;
            return { chart, series: candlestickSeries };
        }

        let mainChart, ceChart, peChart;
        let updateInterval = null;

        async function init() {
            console.log("Initializing...");
            const main = createChart('main-chart', 400);
            const ce = createChart('ce-chart', 300);
            const pe = createChart('pe-chart', 300);

            mainChart = main.chart;
            ceChart = ce.chart;
            peChart = pe.chart;

            series.main = main.series;
            series.ce = ce.series;
            series.pe = pe.series;

            document.getElementById('load-btn').addEventListener('click', () => {
                loadData();
                setupPolling();
            });

            document.getElementById('live-mode').addEventListener('change', setupPolling);

            loadData();
            setupPolling();
        }

        function setupPolling() {
            if (updateInterval) clearInterval(updateInterval);
            if (document.getElementById('live-mode').checked) {
                updateInterval = setInterval(loadData, 5000); // 5 sec poll
            }
        }

        async function loadData() {
            const symbol = document.getElementById('symbol-select').value;
            const date = document.getElementById('date-select').value;
            const live = document.getElementById('live-mode').checked;
            const mode = live ? 'live' : 'backtest';

            try {
                // Fetch Index
                const indexRes = await fetch(`/api/candles?symbol=${symbol}&date=${date}&mode=${mode}`);
                const indexData = await indexRes.json();
                if (indexData.data && indexData.data.length > 0) {
                    series.main.setData(indexData.data);
                    document.getElementById('index-title').innerText = `${indexData.symbol} Index`;
                    if (isFirstLoad) setTimeout(() => mainChart.timeScale().fitContent(), 100);
                }

                // Resolve Options
                const atmRes = await fetch(`/api/atm_options?symbol=${symbol}&date=${date}`);
                const atm = await atmRes.json();

                if (atm.ce) {
                    const ceRes = await fetch(`/api/candles?symbol=${atm.ce.key}&date=${date}&mode=${mode}`);
                    const ceData = await ceRes.json();
                    if (ceData.data && ceData.data.length > 0) {
                        series.ce.setData(ceData.data);
                        document.getElementById('ce-title').innerText = `ATM CE: ${atm.ce.name}`;
                        if (isFirstLoad) setTimeout(() => ceChart.timeScale().fitContent(), 100);
                        applyMarkers(series.ce, atm.ce.key, date);
                    }
                }

                if (atm.pe) {
                    const peRes = await fetch(`/api/candles?symbol=${atm.pe.key}&date=${date}&mode=${mode}`);
                    const peData = await peRes.json();
                    if (peData.data && peData.data.length > 0) {
                        series.pe.setData(peData.data);
                        document.getElementById('pe-title').innerText = `ATM PE: ${atm.pe.name}`;
                        if (isFirstLoad) setTimeout(() => peChart.timeScale().fitContent(), 100);
                        applyMarkers(series.pe, atm.pe.key, date);
                    }
                }

                isFirstLoad = false;
            } catch (e) {
                console.error("Load failed:", e);
            }
        }

        async function applyMarkers(candlestickSeries, instrumentKey, date) {
            const res = await fetch(`/api/trades?symbol=${instrumentKey}&date=${date}`);
            const data = await res.json();
            const markers = [];

            data.trades.forEach(trade => {
                markers.push({
                    time: trade.entry_time_unix,
                    position: 'belowBar',
                    color: '#2196F3',
                    shape: 'arrowUp',
                    text: 'Entry @ ' + trade.entry_price
                });
                if (trade.exit_time_unix) {
                    markers.push({
                        time: trade.exit_time_unix,
                        position: 'aboveBar',
                        color: trade.outcome === 'WIN' ? '#4CAF50' : '#FF5252',
                        shape: 'arrowDown',
                        text: trade.exit_reason + ' @ ' + trade.exit_price
                    });
                }
            });

            candlestickSeries.setMarkers(markers.sort((a, b) => a.time - b.time));
        }

        window.onload = init;
    </script>
</body>
</html>
